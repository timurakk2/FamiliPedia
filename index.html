<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FamiliPedia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <style>
      body, html { -webkit-tap-highlight-color: transparent; }
      ::-webkit-scrollbar { width: 12px; height: 12px; }
      ::-webkit-scrollbar-thumb { background-color: rgba(0,0,0,0.2); border-radius: 6px; border: 3px solid transparent; background-clip: content-box; }
      .prose h2 { font-size: 1.5rem; font-weight: 700; margin-top: 2em; margin-bottom: 1em; }
      .prose a { color: #007aff; text-decoration: none; font-weight: 500; }
      .prose a:hover { text-decoration: underline; }
      summary { cursor: pointer; list-style: none; user-select: none; }
      summary::-webkit-details-marker { display: none; }
      summary .summary-arrow { transition: transform 0.2s; }
      details[open] > summary .summary-arrow { transform: rotate(90deg); }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      .animate-fade-in { animation: fadeIn 0.2s ease-out forwards; }
      
      /* --- СТИЛИ ДЛЯ СНОСОК --- */
      .footnote-link {
        cursor: help;
        text-decoration: none;
        color: inherit;
        font-weight: inherit;
        border-bottom: 1.5px dotted black;
        background: linear-gradient(to top, rgba(255, 229, 100, 0.5) 60%, transparent 60%);
      }
      /* --- СТИЛИ ДЛЯ УПОМИНАНИЙ --- */
      .mention-link {
        cursor: pointer;
        color: #007aff;
        font-weight: 500;
        background: rgba(0, 122, 255, 0.1);
        padding: 2px 4px;
        border-radius: 4px;
        transition: background-color 0.2s;
      }
      .mention-link:hover {
        text-decoration: none;
        background: rgba(0, 122, 255, 0.15);
      }
    </style>
    <script>
      tailwind.config = {
        theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Lora', 'serif'] }, colors: { 'brand-bg': '#f8f8fa', 'brand-sidebar': '#ffffff', 'brand-surface': '#ffffff', 'brand-border': '#e5e5e5', 'brand-text-primary': '#1d1d1f', 'brand-text-secondary': '#6e6e73', 'brand-accent': '#007aff', 'brand-accent-hover': '#0062cc' }, borderRadius: { 'xl': '1rem', '2xl': '1.5rem' }, } }
      }
    </script>
    <script type="importmap">
    { "imports": { "marked": "https://esm.sh/marked@^12.0.2", "dompurify": "https://esm.sh/dompurify@^3.1.2" } }
    </script>
</head>
<body class="bg-brand-bg antialiased">
    <div id="app-container" class="relative min-h-screen md:flex md:flex-row font-sans text-brand-text-primary bg-brand-bg overflow-hidden">
        <!-- Содержимое рендерится здесь -->
    </div>
    
    <div id="footnote-popup" class="hidden absolute z-50 max-w-sm p-4 bg-white rounded-xl shadow-xl border border-gray-200 text-sm text-brand-text-primary"></div>
    <div id="mention-popup" class="hidden absolute z-50 max-w-xs p-4 bg-white rounded-xl shadow-xl border border-gray-200 text-sm text-center">
        <p id="mention-text" class="mb-3"></p>
        <button id="mention-confirm" class="w-full bg-brand-accent text-white font-semibold py-2 px-4 rounded-lg hover:bg-brand-accent-hover transition-colors">Перейти</button>
    </div>

    <script type="module">
      import { relativesData, eventsData } from './data.js';
      import { marked } from 'marked';
      import DOMPurify from 'dompurify';

      const state = {
        items: [
          ...relativesData.map(item => ({ ...item, id: `rel-${item.id}`, type: 'relative' })),
          ...eventsData.map(item => ({ ...item, id: `evt-${item.id}`, type: 'event' }))
        ],
        selectedItemId: null,
        searchTerm: '',
      };

      const ICONS = { /* ИКОНКИ ОСТАЮТСЯ БЕЗ ИЗМЕНЕНИЙ */ 
        bookOpen: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-brand-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
        search: `<svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-brand-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`,
        warning: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/></svg>`,
        info: `<svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
        lock: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>`,
        pencil: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L14.732 3.732z" /></svg>`,
        copy: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>`,
        menu: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>`,
        welcomeBook: `<svg xmlns="http://www.w3.org/2000/svg" class="w-24 h-24 text-gray-200 mb-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`
      };
      
      const appContainer = document.getElementById('app-container');
      const footnotePopup = document.getElementById('footnote-popup');
      const mentionPopup = document.getElementById('mention-popup');

      // --- ИСПРАВЛЕННАЯ ФУНКЦИЯ ОБРАБОТКИ КОНТЕНТА ---
      function processContent(rawContent) {
        if (!rawContent) return '';
        let tempContent = rawContent;
        const replacements = {};
        let counter = 0;
        const createPlaceholder = (type) => `__${type}_${counter++}__`;

        // 1. Найти и заменить сноски на плейсхолдеры
        tempContent = tempContent.replace(/\[\^([^:]+):([^\]]+)\]/g, (match, text, footnote) => {
            const placeholder = createPlaceholder('FOOTNOTE');
            const encodedFootnote = DOMPurify.sanitize(footnote.trim()).replace(/"/g, '&quot;');
            replacements[placeholder] = `<a href="#" class="footnote-link" data-footnote-content="${encodedFootnote}">${DOMPurify.sanitize(text.trim())}</a>`;
            return placeholder;
        });

        // 2. Найти и заменить упоминания на плейсхолдеры
        tempContent = tempContent.replace(/\[@([^:]+):([^\]]+)\]/g, (match, text, id) => {
            const placeholder = createPlaceholder('MENTION');
            const safeText = DOMPurify.sanitize(text.trim());
            const safeId = DOMPurify.sanitize(id.trim());
            replacements[placeholder] = `<a href="#" class="mention-link" data-mention-id="${safeId}" data-mention-name="${safeText}">${safeText}</a>`;
            return placeholder;
        });
        
        // 3. Обработать оставшийся Markdown
        let html = marked.parse(tempContent);

        // 4. Вернуть HTML-теги на место плейсхолдеров
        for (const placeholder in replacements) {
            html = html.replace(new RegExp(placeholder, 'g'), replacements[placeholder]);
        }
        
        return html;
      }

      function renderFullPage() {
        const item = state.items.find(i => i.id === state.selectedItemId);
        appContainer.innerHTML = `<div id="sidebar-overlay" class="fixed inset-0 bg-black/60 z-30 ${document.body.dataset.sidebarOpen === 'true' ? '' : 'hidden'} md:hidden"></div><aside id="sidebar" class="fixed top-0 left-0 w-80 bg-brand-sidebar flex flex-col h-full border-r border-black/10 z-40 transform ${document.body.dataset.sidebarOpen === 'true' ? 'translate-x-0' : '-translate-x-full'} transition-transform duration-300 ease-in-out md:relative md:w-72 lg:w-80 md:translate-x-0 md:shrink-0">${renderSidebarHtml()}</aside><main id="main-content" class="flex-1 h-screen relative overflow-y-auto bg-brand-surface">${renderMainContentHtml(item)}</main>`;
      }

      function renderSidebarHtml() {
        const filteredItems = state.items.filter(i => (i.name || '').toLowerCase().includes(state.searchTerm.toLowerCase()));
        const createListHtml = (items) => {
          if (!items || items.length === 0) return '<li class="text-sm text-gray-500 p-2">Ничего не найдено</li>';
          return items.map(item => {
            const isActive = item.id === state.selectedItemId;
            const activeClasses = 'bg-brand-accent text-white shadow-md shadow-blue-500/30';
            const inactiveClasses = 'text-brand-text-primary hover:bg-black/5';
            return `<li data-id="${item.id}"><a href="#${item.id}" class="block p-2.5 my-1 rounded-lg text-left w-full transition-colors duration-150 ${isActive ? activeClasses : inactiveClasses}"><span class="font-medium">${item.name}</span></a></li>`;
          }).join('');
        };
        const relativesHtml = createListHtml(filteredItems.filter(i => i.type === 'relative'));
        const eventsHtml = createListHtml(filteredItems.filter(i => i.type === 'event'));
        return `<div class="p-4 border-b border-black/10 flex items-center justify-between flex-shrink-0"><div class="flex items-center space-x-3">${ICONS.bookOpen}<h1 class="text-xl font-semibold text-brand-text-primary">FamiliPedia</h1></div></div><div class="p-4 flex-shrink-0"><div class="relative"><input type="text" placeholder="Search..." value="${state.searchTerm}" id="search-input" class="w-full pl-10 pr-4 py-2 bg-gray-100 text-brand-text-primary placeholder-brand-text-secondary border border-transparent rounded-lg focus:ring-2 focus:ring-brand-accent focus:outline-none focus:bg-white transition-all duration-300"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">${ICONS.search}</div></div></div><nav class="flex-1 overflow-y-auto px-4 pt-0"><details open class="mb-4"><summary class="flex items-center space-x-2 p-2 rounded-lg bg-gray-100 text-brand-text-primary"><span class="summary-arrow text-gray-500">▶</span><span>👨‍👩‍👧‍👦 Родственники</span></summary><ul class="pt-2 pl-4">${relativesHtml}</ul></details><details open><summary class="flex items-center space-x-2 p-2 rounded-lg bg-gray-100 text-brand-text-primary"><span class="summary-arrow text-gray-500">▶</span><span>🗓️ События</span></summary><ul class="pt-2 pl-4">${eventsHtml}</ul></details></nav>`;
      }
      
      function renderMainContentHtml(item) {
        const getMobileHeader = () => `<header class="p-4 border-b border-brand-border flex items-center md:hidden sticky top-0 bg-brand-surface/80 backdrop-blur-sm z-10"><button id="menu-button" class="p-2 -ml-2 mr-2 text-gray-600 hover:bg-gray-100 rounded-full">${ICONS.menu}</button><h2 class="text-lg font-semibold text-brand-text-primary truncate">${item ? item.name : 'FamiliPedia'}</h2></header>`;
        if (!item) {
          return `<div class="h-full">${getMobileHeader()}<div class="flex flex-col items-center justify-center h-full text-center p-8"><div>${ICONS.welcomeBook}</div><h2 class="text-4xl font-bold font-serif text-brand-text-primary mb-2">Welcome to FamiliPedia</h2><p class="text-xl text-brand-text-secondary max-w-2xl mb-8 font-sans">Your personal space to cherish family stories.</p></div></div>`;
        }
        const renderArticleBody = () => {
          if (item.lockReason) return `<div class="border-t border-brand-border mt-8 pt-8"><div class="bg-gray-100 border border-gray-200 rounded-xl p-6 flex items-center space-x-5"><div class="shrink-0">${ICONS.lock}</div><div><h3 class="text-lg font-bold text-brand-text-primary font-serif">Просмотр статьи ограничен</h3><p class="text-brand-text-secondary mt-1 text-sm">${item.lockReason}</p></div></div></div>`;
          if (item.editingNotice) return `<div class="border-t border-brand-border mt-8 pt-8"><div class="bg-gray-100 border border-gray-200 rounded-xl p-6 flex items-center space-x-5"><div class="shrink-0">${ICONS.pencil}</div><div><h3 class="text-lg font-bold text-brand-text-primary font-serif">Статья в процессе редактирования</h3><p class="text-brand-text-secondary mt-1 text-sm">${item.editingNotice}</p></div></div></div>`;
          let bannersHtml = '';
          if (item.neutralityBanner) bannersHtml += `<div class="flex items-start p-4 space-x-4 bg-yellow-100/80 text-yellow-800 border border-yellow-300/80 rounded-xl"><div class="shrink-0">${ICONS.warning}</div><p class="text-sm font-medium">${item.neutralityBanner}</p></div>`;
          if (item.unverifiedBanner) bannersHtml += `<div class="flex items-start mt-4 p-4 space-x-4 bg-blue-100/80 text-blue-800 border border-blue-200/80 rounded-xl"><div class="shrink-0">${ICONS.info}</div><p class="text-sm font-medium">${item.unverifiedBanner}</p></div>`;
          if (bannersHtml) bannersHtml = `<div class="mb-8">${bannersHtml}</div>`;
          const infoboxHtml = (() => {
              if (!item.details && !item.imageUrl) return '';
              const hasDetails = item.details && Object.keys(item.details).length > 0;
              const shareLink = `${window.location.origin}${window.location.pathname}#${item.id}`;
              const shareLinkHtml = `<div class="mt-4 pt-4 border-t border-brand-border/60"><div class="font-semibold text-brand-text-secondary text-sm mb-2">Ссылка на статью</div><div class="flex items-center space-x-2"><input type="text" readonly value="${shareLink}" class="w-full truncate bg-gray-100 text-brand-accent text-sm p-2 rounded-md border-transparent focus:ring-2 focus:ring-brand-accent"><button data-copy-link="${shareLink}" class="flex-shrink-0 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-3 rounded-md transition-colors">${ICONS.copy}</button></div></div>`;
              return `<div class="mb-6 sm:float-right sm:ml-6 sm:mb-6 w-full sm:w-64 md:w-72 lg:w-80 clear-right [shape-outside:margin-box] [shape-margin:1.5rem]"><aside class="border border-brand-border rounded-xl bg-gray-50/50 backdrop-blur-sm shadow-subtle overflow-hidden">${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.name}" class="w-full h-auto object-cover">` : ''}<div class="p-4 text-sm">${hasDetails ? `<dl class="space-y-3">${Object.entries(item.details).map(([key, value]) => `<div><dt class="font-semibold text-brand-text-secondary">${key}</dt><dd class="text-brand-text-primary mt-0.5">${Array.isArray(value) ? `<ul class="list-none pl-0">${value.map(v => `<li>${v}</li>`).join('')}</ul>` : value}</dd></div>`).join('')}</dl>` : ''}${shareLinkHtml}</div></aside></div>`;
          })();
          
          const processedHtml = processContent(item.content);
          const markdownHtml = `<div class="prose prose-lg max-w-none text-brand-text-primary leading-relaxed font-serif selection:bg-brand-accent selection:text-white">${processedHtml}</div>`;
          return `${bannersHtml}<div class="md:border-t md:border-brand-border md:pt-8">${infoboxHtml}${markdownHtml}</div>`;
        };
        return `<div class="h-full animate-fade-in">${getMobileHeader()}<div class="p-6 sm:p-8 md:p-12"><div class="max-w-4xl mx-auto"><div class="mb-8"><h1 class="text-3xl md:text-4xl lg:text-5xl font-bold font-serif text-brand-text-primary">${item.name}</h1></div>${renderArticleBody()}</div></div></div>`;
      }
      
      function toggleSidebar(forceClose = false) {
        document.body.dataset.sidebarOpen = forceClose ? 'false' : !(document.body.dataset.sidebarOpen === 'true');
        renderFullPage();
      }

      function handleUrlChange() {
        const hash = window.location.hash.substring(1);
        if (hash && state.items.find(i => i.id === hash)) {
          if (state.selectedItemId !== hash) {
            state.selectedItemId = hash;
            renderFullPage();
          }
        }
      }

      function init() {
        marked.setOptions({ gfm: true, breaks: true });

        const initialId = window.location.hash.substring(1);
        if (initialId && state.items.find(i => i.id === initialId)) {
          state.selectedItemId = initialId;
        } else if (state.items.length > 0) {
          state.selectedItemId = state.items[0].id;
          window.history.replaceState(null, '', '#' + state.selectedItemId);
        }
        renderFullPage();

        document.addEventListener('click', (e) => {
            // ... (Вся логика обработчиков кликов остается без изменений) ...
            const app = e.target.closest('#app-container');
            if (app) {
              const link = e.target.closest('li[data-id] a');
              if (link) { 
                  e.preventDefault(); 
                  const id = link.parentElement.dataset.id; 
                  if (id !== state.selectedItemId) { window.location.hash = id; } 
                  if (window.innerWidth < 768) { toggleSidebar(true); }
                  return;
              }
              const directLink = e.target.closest('a[href^="#"]');
              if (directLink && !e.target.closest('.footnote-link, .mention-link')) {
                  e.preventDefault();
                  const id = directLink.getAttribute('href').substring(1);
                  if (id !== state.selectedItemId) { window.location.hash = id; }
                  return;
              }
              const copyButton = e.target.closest('[data-copy-link]');
              if (copyButton) { navigator.clipboard.writeText(copyButton.dataset.copyLink).then(() => { const originalContent = copyButton.innerHTML; copyButton.innerHTML = 'Скопировано!'; setTimeout(() => { copyButton.innerHTML = originalContent; }, 2000); }); return; }
              if (e.target.closest('#menu-button')) { toggleSidebar(); return; }
              if (e.target.id === 'sidebar-overlay') { toggleSidebar(true); return; }
            }
            const footnoteLink = e.target.closest('.footnote-link');
            const mentionLink = e.target.closest('.mention-link');
            const isPopupClick = e.target.closest('#footnote-popup, #mention-popup');
            if (!footnoteLink && !mentionLink && !isPopupClick) {
              footnotePopup.classList.add('hidden');
              mentionPopup.classList.add('hidden');
            }
            if (footnoteLink) {
              e.preventDefault();
              mentionPopup.classList.add('hidden');
              const content = footnoteLink.dataset.footnoteContent;
              footnotePopup.innerHTML = content;
              const rect = footnoteLink.getBoundingClientRect();
              footnotePopup.style.left = `${rect.left + window.scrollX}px`;
              footnotePopup.style.top = `${rect.bottom + window.scrollY + 8}px`;
              footnotePopup.classList.remove('hidden');
              return;
            }
            if (mentionLink) {
              e.preventDefault();
              footnotePopup.classList.add('hidden');
              const name = mentionLink.dataset.mentionName;
              const targetId = mentionLink.dataset.mentionId;
              document.getElementById('mention-text').innerHTML = `Перейти к статье о <strong>${name}</strong>?`;
              document.getElementById('mention-confirm').dataset.targetId = targetId;
              const rect = mentionLink.getBoundingClientRect();
              mentionPopup.style.left = `${rect.left + window.scrollX}px`;
              mentionPopup.style.top = `${rect.bottom + window.scrollY + 8}px`;
              mentionPopup.classList.remove('hidden');
              return;
            }
            if (e.target.id === 'mention-confirm') {
              const targetId = e.target.dataset.targetId;
              window.location.hash = targetId;
              mentionPopup.classList.add('hidden');
            }
        });

        appContainer.addEventListener('input', (e) => {
          if (e.target.id === 'search-input') {
            state.searchTerm = e.target.value;
            document.getElementById('sidebar').innerHTML = renderSidebarHtml();
            const searchInput = document.getElementById('search-input');
            searchInput.focus();
            searchInput.setSelectionRange(state.searchTerm.length, state.searchTerm.length);
          }
        });
        
        window.addEventListener('hashchange', handleUrlChange);
      }
      init();
    </script>
</body>
</html>
